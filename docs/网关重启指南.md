# Clawdbot 网关重启指南

## 🚨 问题现象
使用 `clawdbot gateway restart` 命令时，终端会卡住不动，无法继续操作。

## 🔍 原因分析
`clawdbot gateway restart` 命令会：
1. 停止当前网关进程
2. 启动新的网关进程
3. 这个过程会**阻塞终端**，直到重启完成（可能几秒到几十秒）

## ✅ 解决方案（5种方法）

### 方法一：使用后台运行（最简单）
```bash
# 在命令末尾加 & 符号，让它在后台运行
~/.npm-global/bin/clawdbot gateway restart &

# 然后可以立即继续其他操作
echo "网关正在后台重启..."
```

### 方法二：使用SIGUSR1信号（优雅重启）
```bash
# 1. 先找到网关进程ID
PID=$(ps aux | grep clawdbot-gateway | grep -v grep | awk '{print $2}')

# 2. 发送重启信号
kill -USR1 $PID

# 3. 验证重启
sleep 3 && ~/.npm-global/bin/clawdbot status
```

### 方法三：使用nohup（完全分离）
```bash
# 完全分离进程，输出重定向到日志文件
nohup ~/.npm-global/bin/clawdbot gateway restart > /tmp/clawdbot-restart.log 2>&1 &

# 查看重启日志
tail -f /tmp/clawdbot-restart.log
```

### 方法四：使用screen/tmux（会话管理）
```bash
# 使用screen创建分离会话
screen -S clawdbot-restart -d -m ~/.npm-global/bin/clawdbot gateway restart

# 或使用tmux
tmux new-session -d -s clawdbot-restart "~/.npm-global/bin/clawdbot gateway restart"
```

### 方法五：分步重启（最可控）
```bash
# 1. 停止网关
~/.npm-global/bin/clawdbot gateway stop

# 2. 等待几秒
sleep 2

# 3. 启动网关
~/.npm-global/bin/clawdbot gateway start &

# 4. 检查状态
sleep 5 && ~/.npm-global/bin/clawdbot status
```

## 📊 方法对比

| 方法 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| **后台运行 (&)** | 最简单，一键操作 | 输出可能丢失 | 日常快速重启 |
| **SIGUSR1信号** | 优雅，不中断服务 | 需要找PID | 生产环境 |
| **nohup** | 完全分离，有日志 | 需要管理日志文件 | 长时间运行 |
| **screen/tmux** | 可恢复会话 | 需要额外工具 | 复杂调试 |
| **分步重启** | 最可控 | 步骤较多 | 故障排查 |

## 🛠️ 实用脚本

### 快速重启脚本
```bash
#!/bin/bash
# quick-restart.sh

echo "正在重启Clawdbot网关..."

# 方法1：后台重启
~/.npm-global/bin/clawdbot gateway restart &

# 等待重启完成
sleep 5

# 检查状态
~/.npm-global/bin/clawdbot status --brief

echo "重启完成！"
```

### 优雅重启脚本
```bash
#!/bin/bash
# graceful-restart.sh

echo "优雅重启Clawdbot网关..."

# 查找网关PID
PID=$(ps aux | grep clawdbot-gateway | grep -v grep | awk '{print $2}')

if [ -z "$PID" ]; then
    echo "错误：未找到运行中的网关进程"
    exit 1
fi

echo "找到网关进程: PID=$PID"

# 发送重启信号
kill -USR1 $PID
echo "已发送重启信号"

# 等待并检查
for i in {1..10}; do
    sleep 1
    echo -n "."
done
echo ""

# 验证重启
~/.npm-global/bin/clawdbot status --channels
```

### 安全重启脚本（带备份）
```bash
#!/bin/bash
# safe-restart.sh

# 备份配置
BACKUP_DIR="$HOME/clawdbot-backups/$(date +%Y%m%d-%H%M%S)"
mkdir -p "$BACKUP_DIR"
cp ~/.clawdbot/clawdbot.json "$BACKUP_DIR/"
echo "配置已备份到: $BACKUP_DIR"

# 重启网关
echo "正在重启网关..."
~/.npm-global/bin/clawdbot gateway restart &

# 等待
sleep 8

# 检查
if ~/.npm-global/bin/clawdbot status --brief > /dev/null 2>&1; then
    echo "✅ 网关重启成功"
else
    echo "❌ 网关重启失败，正在恢复备份..."
    cp "$BACKUP_DIR/clawdbot.json" ~/.clawdbot/
    ~/.npm-global/bin/clawdbot gateway restart &
    sleep 5
fi
```

## 🔧 重启后验证

### 基本状态检查
```bash
# 简单状态
~/.npm-global/bin/clawdbot status

# 详细状态
~/.npm-global/bin/clawdbot status --all

# 只检查通道
~/.npm-global/bin/clawdbot status --channels
```

### 日志检查
```bash
# 查看最近日志
tail -20 ~/.clawdbot/logs/gateway.log

# 实时查看日志
~/.npm-global/bin/clawdbot logs --follow

# 搜索错误
grep -i error ~/.clawdbot/logs/gateway.log | tail -10
```

### 通道状态检查
```bash
# 检查所有通道
~/.npm-global/bin/clawdbot status --deep

# 检查特定通道（如飞书）
~/.npm-global/bin/clawdbot status --deep | grep -A5 -B5 "Feishu"
```

## 🚑 故障排除

### 如果重启后网关未运行
```bash
# 1. 检查进程
ps aux | grep -i clawdbot

# 2. 查看错误日志
tail -50 ~/.clawdbot/logs/gateway.log

# 3. 尝试手动启动
~/.npm-global/bin/clawdbot gateway start &

# 4. 检查端口
lsof -i :18789
```

### 如果配置更改未生效
```bash
# 1. 确认配置已保存
cat ~/.clawdbot/clawdbot.json | grep -A3 -B3 "你的配置项"

# 2. 强制重新加载
kill -USR1 $(pgrep -f "clawdbot-gateway")

# 3. 检查插件状态
~/.npm-global/bin/clawdbot plugins list
```

### 如果特定通道有问题（如飞书）
```bash
# 1. 检查插件依赖
ls -la ~/.clawdbot/extensions/feishu/node_modules/

# 2. 查看通道日志
~/.npm-global/bin/clawdbot logs --follow | grep -i feishu

# 3. 重新安装插件
cd ~/.clawdbot/extensions/feishu && npm install
```

## 📝 最佳实践

### 日常维护
1. **定期重启**：每周重启一次，清理内存
2. **配置备份**：修改配置前先备份
3. **日志监控**：关注错误和警告日志

### 变更管理
1. **测试环境**：先在测试环境验证配置
2. **逐步变更**：一次只改一个配置项
3. **验证回滚**：确保能快速恢复

### 监控告警
```bash
# 简单健康检查脚本
#!/bin/bash
if ! ~/.npm-global/bin/clawdbot status --brief > /dev/null 2>&1; then
    echo "警告：Clawdbot网关异常" | mail -s "Clawdbot告警" your-email@example.com
    # 自动重启
    ~/.npm-global/bin/clawdbot gateway restart &
fi
```

## 🎯 总结

### 推荐使用场景：
- **日常使用**：方法一（后台运行）
- **生产环境**：方法二（SIGUSR1信号）
- **故障排查**：方法五（分步重启）

### 关键要点：
1. **不要直接运行** `clawdbot gateway restart`（会卡住）
2. **总是验证**重启后的状态
3. **保持备份**重要配置
4. **监控日志**及时发现问题

---

**创建时间**：2026年1月30日  
**基于经验**：飞书集成配置过程中的实际问题  
**适用版本**：Clawdbot 2026.1.24-3  
**维护建议**：定期更新此指南