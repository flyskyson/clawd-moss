# 飞书集成测试指南

## 🎯 **测试目标**
验证Clawdbot与飞书的集成是否成功，评估是否可作为iMessage的替代方案。

## 📋 **测试前准备确认**

### ✅ 已完成配置
1. **飞书插件安装**：✅ 已安装并加载
2. **Clawdbot配置**：✅ 已保存到配置文件
3. **网关状态**：✅ 已重启，运行正常
4. **通道状态**：✅ 显示为 ON 和 OK

### ✅ 飞书平台配置
1. **应用创建**：✅ Clawdbot助手应用已创建
2. **权限配置**：✅ im:message, im:message:send_as_bot, im:chat:read, im:chat
3. **事件订阅**：✅ 配置了长连接模式（WebSocket）
4. **凭证获取**：✅ App ID和App Secret已配置

### ⏳ 待完成操作
1. **应用发布**：需要在飞书开放平台发布应用
2. **连接测试**：需要发送测试消息验证

## 🚀 **测试步骤**

### 第一步：发布飞书应用
1. 访问飞书开放平台：https://open.feishu.cn/
2. 登录你的账号
3. 进入"Clawdbot助手"应用
4. 左侧菜单 → "版本管理与发布"
5. 点击"创建版本"
6. 填写版本信息：
   - 版本号：1.0.0
   - 版本说明：AI助手集成测试版
   - 可用范围：建议选择"全员"
7. 点击"申请发布"
8. 等待审核（个人应用通常自动通过）

### 第二步：检查长连接状态
应用发布后：
1. 回到"开发配置 → 事件与回调"页面
2. 查看长连接状态：
   - ✅ 理想状态："长连接已建立"
   - ⚠️ 可能状态："应用未建立长连接"（需要触发连接）
   - ❌ 错误状态：显示错误信息

### 第三步：发送测试消息
1. 打开飞书客户端（手机或电脑）
2. 搜索"Clawdbot助手"
3. 打开应用对话界面
4. 发送测试消息（任选其一）：
   - "Hello"
   - "测试"
   - "ping"
5. 等待回复（应在几秒内）

### 第四步：验证功能
如果收到回复，测试：
1. **基本回复**：发送"你好"，应收到友好回复
2. **功能测试**：发送"帮助"，应显示功能列表
3. **延迟测试**：记录消息往返时间
4. **稳定性**：连续发送几条消息测试稳定性

## 🔧 **预期结果**

### 成功指标
1. ✅ **连接建立**：飞书平台显示"长连接已建立"
2. ✅ **消息收发**：发送消息后能收到MOSS的回复
3. ✅ **低延迟**：消息往返时间<3秒
4. ✅ **稳定性**：连续消息不中断

### 失败处理
如果测试失败：

#### 情况A：应用发布失败
**可能原因**：
- 权限配置不完整
- 应用信息填写错误
- 审核被拒绝

**解决方案**：
1. 检查权限配置是否完整
2. 重新填写应用信息
3. 联系飞书客服（如果需要）

#### 情况B：长连接未建立
**可能原因**：
- Clawdbot网关未运行
- 网络防火墙阻止
- 凭证配置错误

**解决方案**：
1. 检查Clawdbot网关状态：`clawdbot status`
2. 检查网络连接
3. 验证App ID和App Secret

#### 情况C：消息无回复
**可能原因**：
- 飞书插件未正确加载
- 消息路由配置问题
- 权限不足

**解决方案**：
1. 检查插件状态：`clawdbot plugins list`
2. 查看网关日志：`tail -f ~/.clawdbot/logs/gateway.log`
3. 重新检查权限配置

## 📊 **测试记录表**

### 测试环境
- **测试时间**：_________
- **测试人员**：飞天
- **Clawdbot版本**：2026.1.24-3
- **飞书客户端**：□ 手机 □ 电脑
- **网络环境**：□ 家庭WiFi □ 移动网络 □ 公司网络

### 测试结果
| 测试项目 | 预期结果 | 实际结果 | 是否通过 | 备注 |
|----------|----------|----------|----------|------|
| 应用发布 | 成功发布 | _________ | □ | |
| 长连接状态 | 已建立 | _________ | □ | |
| 消息发送 | 成功发送 | _________ | □ | |
| 消息接收 | 收到回复 | _________ | □ | 延迟：___秒 |
| 基本功能 | 正常回复 | _________ | □ | |
| 连续测试 | 稳定运行 | _________ | □ | |

### 性能指标
- **平均延迟**：_________ 秒
- **成功率**：_________ %
- **稳定性**：□ 优秀 □ 良好 □ 一般 □ 差

## 💡 **优化建议**

### 如果测试成功
1. **设为默认通道**：将飞书设为主要通讯工具
2. **优化配置**：调整超时、重试等参数
3. **扩展功能**：测试群聊、文件传输等功能
4. **备份方案**：保持iMessage作为备用

### 如果测试部分成功
1. **问题定位**：确定具体失败环节
2. **针对性优化**：针对问题调整配置
3. **替代方案**：考虑Webhook模式
4. **分阶段实施**：先使用基本功能，逐步完善

### 如果测试失败
1. **详细诊断**：收集完整错误信息
2. **技术研究**：深入研究飞书集成技术
3. **替代工具**：评估其他国内通讯工具
4. **保持现状**：继续使用iMessage，优化现有连接

## 🔄 **后续步骤**

### 测试成功后
1. **正式启用**：将飞书作为主要通讯工具
2. **通知切换**：告知联系人新的联系方式
3. **性能监控**：建立长期监控机制
4. **定期评估**：每月评估使用效果

### 集成到工作流程
1. **与秘书系统集成**：通过飞书接收提醒和报告
2. **与知识管理集成**：飞书文档与Obsidian/Notion同步
3. **与任务管理集成**：通过飞书跟踪任务进度
4. **与Git集成**：代码变更通过飞书通知

## 📝 **技术细节参考**

### 当前配置
```json
"feishu": {
  "appId": "cli_a9f15140edb8dbb4",
  "appSecret": "RPrX1tQ39NTHGSKLB0kHJcGh7ruRoC1P",
  "enabled": true,
  "connectionMode": "websocket",
  "dmPolicy": "pairing",
  "groupPolicy": "allowlist",
  "requireMention": true
}
```

### 监控命令
```bash
# 检查状态
clawdbot status --channels

# 查看日志
tail -f ~/.clawdbot/logs/gateway.log | grep -i feishu

# 测试连接
curl -I https://open.feishu.cn
```

### 故障排查命令
```bash
# 重启网关（如果连接问题）
kill -USR1 $(pgrep -f "clawdbot-gateway")

# 重新加载配置
clawdbot config set channels.feishu.debug true
clawdbot gateway restart &
```

---

**创建时间**：2026年1月30日  
**创建目的**：为飞书集成测试提供完整指南  
**适用对象**：飞天（用户）  
**预期用时**：15-30分钟  
**成功标准**：消息收发正常，延迟可接受