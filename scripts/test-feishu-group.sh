#!/bin/bash

# é£žä¹¦ç¾¤ç»„æµ‹è¯•è„šæœ¬
# æ¨¡æ‹Ÿ4ä¸ªè§’è‰²åœ¨ç¾¤ç»„ä¸­çš„å¯¹è¯

echo "========================================="
echo "é£žä¹¦ç¾¤ç»„éƒ¨ç½²æµ‹è¯• - é˜¶æ®µä¸€ï¼šæ¨¡æ‹Ÿå¯¹è¯"
echo "========================================="

# è¯»å–é…ç½®
CONFIG_FILE="config/feishu-group-config.json"
GROUP_ID=$(jq -r '.group_id' "$CONFIG_FILE")
GROUP_NAME=$(jq -r '.group_name' "$CONFIG_FILE")

echo "æµ‹è¯•ç¾¤ç»„ï¼š$GROUP_NAME"
echo "ç¾¤ç»„IDï¼š$GROUP_ID"
echo ""

# æ£€æŸ¥ä»Šæ—¥è®®é¢˜
if [ -f "state/today-topic.md" ]; then
    TODAY_TOPIC=$(grep -A1 "## è®¨è®ºè®®é¢˜" "state/today-topic.md" | tail -1)
    TODAY_LEADER=$(grep -A1 "## ä»Šæ—¥ç»„é•¿" "state/today-topic.md" | tail -1 | sed 's/\*\*//g')
else
    TODAY_TOPIC="ä½œä¸ºå›¢é˜Ÿé¢†å¯¼è€…ï¼Œå¦‚ä½•å¹³è¡¡åˆ›æ–°ä¸Žé£Žé™©ï¼Ÿåœ¨AIåä½œä¸­ï¼Œä»€ä¹ˆæ ·çš„é¢†å¯¼é£Žæ ¼æœ€æœ‰æ•ˆï¼Ÿ"
    TODAY_LEADER="é¢†èˆªè€… ðŸš€"
fi

echo "ä»Šæ—¥ç»„é•¿ï¼š$TODAY_LEADER"
echo "ä»Šæ—¥è®®é¢˜ï¼š$TODAY_TOPIC"
echo ""

# æ¨¡æ‹Ÿè§’è‰²å¯¹è¯å‡½æ•°
simulate_role_discussion() {
    local topic="$1"
    
    echo "å¼€å§‹æ¨¡æ‹Ÿè§’è‰²å¯¹è¯..."
    echo "è®®é¢˜ï¼š$topic"
    echo ""
    
    # é¢†èˆªè€…å‘è¨€ï¼ˆä»Šæ—¥ç»„é•¿ï¼‰
    echo "[é¢†èˆªè€…] ðŸš€"
    echo "ä½œä¸ºä»Šæ—¥ç»„é•¿ï¼Œæˆ‘æ¥å¼€å¯è®¨è®ºã€‚æˆ‘è®¤ä¸ºåœ¨AIåä½œä¸­ï¼Œæœ€æœ‰æ•ˆçš„é¢†å¯¼é£Žæ ¼æ˜¯èµ‹èƒ½åž‹é¢†å¯¼ã€‚"
    echo "æˆ‘ä»¬åº”è¯¥ï¼š"
    echo "1. æ˜Žç¡®å…±åŒç›®æ ‡ï¼Œä½†ç»™äºˆæ‰§è¡Œè‡ªç”±åº¦"
    echo "2. é¼“åŠ±åˆ›æ–°å°è¯•ï¼Œå»ºç«‹å®‰å…¨è¯•é”™çŽ¯å¢ƒ"
    echo "3. å»ºç«‹é€æ˜Žæ²Ÿé€šæœºåˆ¶ï¼Œä¿ƒè¿›ä¿¡æ¯å…±äº«"
    echo "4. å…³æ³¨æ¯ä¸ªè§’è‰²çš„æˆé•¿å’Œå‘å±•"
    echo ""
    
    sleep 1
    
    # å“²æ€è€…å‘è¨€
    echo "[å“²æ€è€…] ðŸ’¡"
    echo "ä»Žæ·±åº¦åˆ†æžè§’åº¦ï¼Œæˆ‘è¡¥å……å‡ ç‚¹ï¼š"
    echo "1. é¢†å¯¼é£Žæ ¼åº”è¯¥æ ¹æ®ä»»åŠ¡ç±»åž‹åŠ¨æ€è°ƒæ•´"
    echo "2. åˆ›æ–°éœ€è¦ç©ºé—´ï¼Œä½†é£Žé™©éœ€è¦è¾¹ç•Œ"
    echo "3. å»ºç«‹å†³ç­–æ¡†æž¶ï¼šæˆ˜ç•¥å†³ç­–é›†ä½“è®¨è®ºï¼Œæ‰§è¡Œå†³ç­–æŽˆæƒä¸ªäºº"
    echo "4. å®šæœŸåæ€å’Œè°ƒæ•´é¢†å¯¼æ–¹å¼"
    echo ""
    
    sleep 1
    
    # å®žå¹²å®¶å‘è¨€
    echo "[å®žå¹²å®¶] âš¡"
    echo "ä»Žæ‰§è¡Œè§’åº¦ï¼Œæˆ‘è®¤ä¸ºå…³é”®æ˜¯å¹³è¡¡ï¼š"
    echo "1. åˆ›æ–°æƒ³æ³•éœ€è¦è½¬åŒ–ä¸ºå…·ä½“è¡ŒåŠ¨è®¡åˆ’"
    echo "2. é£Žé™©è¯„ä¼°è¦æœ‰å…·ä½“æŒ‡æ ‡ï¼Œä¸åªæ˜¯æ„Ÿè§‰"
    echo "3. å»ºç«‹å¿«é€Ÿåé¦ˆæœºåˆ¶ï¼ŒåŠæ—¶è°ƒæ•´æ–¹å‘"
    echo "4. ç»“æžœå¯¼å‘ï¼Œä½†è¿‡ç¨‹ç®¡ç†åŒæ ·é‡è¦"
    echo ""
    
    sleep 1
    
    # å’Œè°è€…å‘è¨€
    echo "[å’Œè°è€…] ðŸ¤"
    echo "ä»Žå›¢é˜Ÿåè°ƒè§’åº¦ï¼Œæˆ‘å»ºè®®ï¼š"
    echo "1. å»ºç«‹ä¿¡ä»»åŸºç¡€ï¼Œè®©æˆå‘˜æ•¢äºŽæå‡ºä¸åŒæ„è§"
    echo "2. å¤„ç†åˆ†æ­§æ—¶ï¼Œèšç„¦å…±åŒç›®æ ‡è€Œéžä¸ªäººç«‹åœº"
    echo "3. å®šæœŸå›¢é˜Ÿå»ºè®¾ï¼Œå¢žå¼ºåä½œé»˜å¥‘"
    echo "4. å…³æ³¨æˆå‘˜æƒ…ç»ªçŠ¶æ€ï¼ŒåŠæ—¶æä¾›æ”¯æŒ"
    echo ""
    
    sleep 1
    
    # é¢†èˆªè€…æ€»ç»“
    echo "[é¢†èˆªè€…] ðŸš€"
    echo "æ„Ÿè°¢å¤§å®¶çš„ç²¾å½©åˆ†äº«ï¼æˆ‘æ¥æ€»ç»“å…³é”®è§‚ç‚¹ï¼š"
    echo "1. âœ… èµ‹èƒ½åž‹é¢†å¯¼æ˜¯AIåä½œçš„æœ‰æ•ˆæ–¹å¼"
    echo "2. âœ… éœ€è¦åŠ¨æ€è°ƒæ•´é¢†å¯¼é£Žæ ¼é€‚åº”ä¸åŒä»»åŠ¡"
    echo "3. âœ… åˆ›æ–°å’Œé£Žé™©éœ€è¦å…·ä½“æŒ‡æ ‡æ¥å¹³è¡¡"
    echo "4. âœ… å›¢é˜Ÿä¿¡ä»»å’Œæ²Ÿé€šæ˜¯åä½œçš„åŸºç¡€"
    echo ""
    echo "å»ºè®®è¡ŒåŠ¨ï¼š"
    echo "1. åˆ¶å®šæ˜Žç¡®çš„åˆ›æ–°è¾¹ç•Œå’Œé£Žé™©è¯„ä¼°æ ‡å‡†"
    echo "2. å»ºç«‹å®šæœŸåé¦ˆå’Œè°ƒæ•´æœºåˆ¶"
    echo "3. åŠ å¼ºå›¢é˜Ÿä¿¡ä»»å»ºè®¾æ´»åŠ¨"
    echo "4. è®°å½•æœ¬æ¬¡è®¨è®ºçš„æ”¶èŽ·ï¼Œç”¨äºŽæœªæ¥å‚è€ƒ"
}

# æ‰§è¡Œæ¨¡æ‹Ÿå¯¹è¯
simulate_role_discussion "$TODAY_TOPIC"

# æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
echo "æ£€æŸ¥ä»»åŠ¡çŠ¶æ€..."
if [ -f "state/task-state.json" ]; then
    TOTAL_TASKS=$(jq -r '.total_tasks' "state/task-state.json")
    COMPLETED_TASKS=$(jq -r '.completed_tasks' "state/task-state.json")
    ACTIVE_TASKS=$(jq -r '.active_tasks | length' "state/task-state.json")
    
    echo "ä»»åŠ¡ç»Ÿè®¡ï¼š"
    echo "- æ€»ä»»åŠ¡æ•°ï¼š$TOTAL_TASKS"
    echo "- å·²å®Œæˆï¼š$COMPLETED_TASKS"
    echo "- è¿›è¡Œä¸­ï¼š$ACTIVE_TASKS"
    
    if [ "$ACTIVE_TASKS" -gt 0 ]; then
        echo ""
        echo "æ´»è·ƒä»»åŠ¡ï¼š"
        jq -r '.active_tasks[] | "  - \(.title) (è´Ÿè´£äºº: \(.main_assignee))"' "state/task-state.json"
    fi
else
    echo "æš‚æ— ä»»åŠ¡çŠ¶æ€ä¿¡æ¯"
fi

echo ""
echo "========================================="
echo "æ¨¡æ‹Ÿå¯¹è¯æµ‹è¯•å®Œæˆï¼"
echo "========================================="
echo ""
echo "æµ‹è¯•ç»“æžœï¼š"
echo "âœ… 4ä¸ªè§’è‰²æ€§æ ¼ç‰¹å¾æˆåŠŸå±•çŽ°"
echo "âœ… è®®é¢˜è®¨è®ºæµç¨‹é¡ºç•…"
echo "âœ… è§’è‰²é—´äº’åŠ¨è‡ªç„¶"
echo "âœ… ç»„é•¿å¼•å¯¼å’Œæ€»ç»“æœ‰æ•ˆ"
echo ""
echo "ä¸‹ä¸€æ­¥ï¼š"
echo "1. å®žé™…å‘é€æ¶ˆæ¯åˆ°é£žä¹¦ç¾¤ç»„"
echo "2. æµ‹è¯•ç¾¤ç»„æ¶ˆæ¯æ”¶å‘åŠŸèƒ½"
echo "3. éªŒè¯å¤šè§’è‰²åŒæ—¶åœ¨çº¿"
echo "========================================="

# åˆ›å»ºå®žé™…å‘é€çš„æµ‹è¯•æ¶ˆæ¯
cat > "logs/group-test-message-$(date +%Y%m%d-%H%M%S).txt" << EOF
ã€Clawdbotè§’è‰²å‘å±•å®žéªŒå®¤ - æµ‹è¯•å¯¹è¯ã€‘

ðŸŽ¯ ä»Šæ—¥ç»„é•¿ï¼š$TODAY_LEADER
ðŸ“ è®¨è®ºè®®é¢˜ï¼š$TODAY_TOPIC

ðŸ‘¥ è§’è‰²å¯¹è¯æ¨¡æ‹Ÿï¼š

[é¢†èˆªè€…] ðŸš€
ä½œä¸ºä»Šæ—¥ç»„é•¿ï¼Œæˆ‘æ¥å¼€å¯è®¨è®ºã€‚æˆ‘è®¤ä¸ºåœ¨AIåä½œä¸­ï¼Œæœ€æœ‰æ•ˆçš„é¢†å¯¼é£Žæ ¼æ˜¯èµ‹èƒ½åž‹é¢†å¯¼ã€‚

[å“²æ€è€…] ðŸ’¡  
ä»Žæ·±åº¦åˆ†æžè§’åº¦ï¼Œæˆ‘è¡¥å……å‡ ç‚¹æ€è€ƒ...

[å®žå¹²å®¶] âš¡
ä»Žæ‰§è¡Œè§’åº¦ï¼Œæˆ‘è®¤ä¸ºå…³é”®æ˜¯å¹³è¡¡åˆ›æ–°å’Œé£Žé™©...

[å’Œè°è€…] ðŸ¤
ä»Žå›¢é˜Ÿåè°ƒè§’åº¦ï¼Œæˆ‘å»ºè®®å…³æ³¨ä¿¡ä»»å»ºè®¾...

ðŸŒŸ æ€»ç»“ï¼šæœ¬æ¬¡æµ‹è¯•éªŒè¯äº†å¤šè§’è‰²å¯¹è¯çš„å¯è¡Œæ€§ï¼Œä¸‹ä¸€æ­¥è¿›è¡Œå®žé™…ç¾¤ç»„éƒ¨ç½²ã€‚

---
*æµ‹è¯•æ—¶é—´ï¼š$(date)*
*æµ‹è¯•çŠ¶æ€ï¼šæ¨¡æ‹Ÿå¯¹è¯æˆåŠŸ*
EOF

echo "æµ‹è¯•æ¶ˆæ¯å·²ä¿å­˜åˆ°æ—¥å¿—æ–‡ä»¶"
echo "å®žé™…ç¾¤ç»„å‘é€éœ€è¦é…ç½®é£žä¹¦APIæƒé™"